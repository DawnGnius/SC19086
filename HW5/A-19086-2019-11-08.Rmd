---
title: "Homework 5"
author: "By 19086"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library('snowfall')
library('ggplot2')
```

## Question 1 (Exercise 7.6)
Efron and Tibshirani discuss the **scor (bootstrap)** test score data on $88$ students who took examinations in five subjects [84, Table 7.1], [188, Table 1.2.1]. 
The first two tests (mechanics, vectors) were closed book and the last three tests (algebra, analysis, statistics) were open book. 
Each row of the data frame is a set of scores $(x_{i1}, . . . , x_{i5})$ for the $i^{th}$ student. 
Use a panel display to display the scatter plots for each pair of test scores. 
Compare the plot with the sample correlation matrix. 
Obtain bootstrap estimates of the standard errors for each of the following estimates: $\hat{\rho}_{12} = \hat{\rho}(mec, vec)$ , $\hat{\rho}_{34} = \hat{\rho}(alg, ana)$, $\hat{\rho}_{35} = \hat{\rho}(alg, sta)$, $\hat{\rho}_{45} = \hat{\rho}(ana, sta)$.


## Answer 1

Firstly, we load data and plot scatter plots for each pair of test scores.
```{r}
library('bootstrap')
scor <- force(scor)   # Forces the evaluation of a function argument.
# scatter plots for each pair of test scores
pairs(scor)
```
Then we compute the sample correlation matrix, plot it and compare it with the figure above.
```{r}
library("corrplot")
cor(scor)
corrplot(cor(scor), tl.col = "black", tl.srt = 45)
```

The correlogram above display the correlation between each pair of test scores and it shows that **alg** is high correlated with other test scores. And all of tests are positive correlated.

Finally, we calculate bootstrap estimates of the standard errors for each of the following estimates: 
$\hat{\rho}_{12} = \hat{\rho}(mec, vec)$, 
$\hat{\rho}_{34} = \hat{\rho}(alg, ana)$, 
$\hat{\rho}_{35} = \hat{\rho}(alg, sta)$, 
$\hat{\rho}_{45} = \hat{\rho}(ana, sta)$.

The bootstrap estimate of standard error of an estimator $\hat{\theta}$ is the sample standard deviation of the bootstrap replicates $\hat{\theta}^{(1)}, \cdots, \hat{\theta}^{(B)}$.

\begin{equation}
  \widehat{\operatorname{se}}\left(\hat{\theta}^* \right)=\sqrt{\frac{1}{B-1}\sum_{b=1}^{B}\left(\hat{\theta}^{(b)}-\widehat{\hat{\theta}^*}\right)^{2}}
\end{equation}
where $\widehat{\hat{\theta}^*} = \frac{1}{B} \sum_{b=1}^B \hat{\theta}^{(b)}$.

```{r}
library("boot")
set.seed(12345)

fun.cor <- function(x,i) cor(x[i,1],x[i,2])

idx <- list(c(1,2), c(3,4), c(3,5), c(4,5))
test.label <- c("mec", "vec", "alg", "ana", "sta")
for (idx.loop in idx) {
  x <- scor[, idx.loop]
  obj <- boot(data=x, statistic=fun.cor, R=100)
  cat("correlation between ", test.label[idx.loop[1]], " and ", test.label[idx.loop[2]], ":\n")
  print(round(c(original=obj$t0,bias=mean(obj$t)-obj$t0,se=sd(obj$t)),3))
  cat("\n")
}
```

The bootstrap estimates of the standard errors are

pairs | SE  
-|-
mec and vec | $0.077$ |
alg and ana | $0.046$ |
alg and sta | $0.060$ |
ana and sta | $0.073$ |




## Question 2 (Project 7.B)
Repeat Project 7.A for the sample skewness statistic. 
Compare the coverage rates for normal populations (skewness $0$) and $\chi^2(5)$ distributions (positive skewness).

#### Project 7.A 

Conduct a Monte Carlo study to estimate the coverage probabilities of the standard normal bootstrap confidence interval, the basic bootstrap confidence interval, and the percentile confidence interval. 
Sample from a normal population and check the empirical coverage rates for the sample mean. 
Find the proportion of times that the confidence intervals miss on the left, and the porportion of times that the confidence intervals miss on the right.


## Answer 2

Firstly, we focus on Normal distribution.
```{r, echo=FALSE}
library(boot)
set.seed(1254)

n <- 50
m <- 1000

skewness <- function(x, i){
  # input data x
  # return statistics b1
  x_bar <- mean(x[i])
  numerator <- mean((x[i]-x_bar)^3)
  denominator <- (mean((x[i]-x_bar)^2))^1.5
  return(numerator / denominator)
}

stat <- replicate(m, expr={
  dat.normal <- rnorm(n, mean=0, sd=1)
  boot.obj <- boot(data=dat.normal, statistic=skewness, R=100)
  boot_ci <- boot.ci(boot.obj, type = c("basic", "norm", "perc"))})

```

Now let's look at the empirical coverage rates and the proportion of times that the confidence intervals miss on the left, and the porportion of times that the confidence intervals miss on the right.

```{r}
fun.tab <- function(stat, mu){
  cover.normal <- cover.basic <- cover.percent <- 0
  cover.normal.left <- cover.basic.left <- cover.percent.left <- 0
  cover.normal.right <- cover.basic.right <- cover.percent.right <- 0
  for (ii in 1:m) {
    if (stat[,ii]$normal[2] <= mu & stat[,ii]$normal[3] >= mu) {
      cover.normal <- cover.normal + 1
    } else if (stat[,ii]$normal[2] > mu) {
      cover.normal.left <- cover.normal.left + 1
    } else {
      cover.normal.right <- cover.normal.right + 1
    }
    
    if (stat[,ii]$basic[4] <= mu & stat[,ii]$basic[5] >= mu) {
      cover.basic <- cover.basic + 1
    } else if (stat[,ii]$basic[4] > mu) {
      cover.basic.left <- cover.basic.left + 1
    } else {
      cover.basic.right <- cover.basic.right + 1
    }
    
    if (stat[,ii]$percent[4] <= mu & stat[,ii]$percent[5] >= mu) {
      cover.percent <- cover.percent + 1
    } else if (stat[,ii]$percent[4] > mu) {
      cover.percent.left <- cover.percent.left + 1
    } else {
      cover.percent.right <- cover.percent.right + 1
    }
  }
  tab <- data.frame(normal=c(cover.normal/m, cover.normal.left/m, cover.normal.right/m), basic=c(cover.basic/m, cover.basic.left/m, cover.basic.right/m), percent=c(cover.percent/m, cover.percent.left/m, cover.percent.right/m))
  rownames(tab) <- c("Cover Rate", "Miss Left", "Miss Right")
  print(tab)
}

fun.tab(stat, mu=0)
```


Now, let's focus on $\chi^2$ discribution. 
```{r}
stat <- replicate(m, expr={
  dat.chi <- rchisq(n, df=5)
  boot.obj <- boot(data=dat.chi, statistic=skewness, R=100)
  boot_ci <- boot.ci(boot.obj, type = c("basic", "norm", "perc"))})
```

We know that the skewness of $\chi^2(5)$ is $\sqrt{8/5}$, then we got the following result. 
```{r}
fun.tab(stat, mu=sqrt(8/5))
```

From the tables above, we find that the coverage rates of normal populations are higher than that of $\chi^2(5)$ populations when using norma, basic or percent interval. 

When population comes from normal distribution, the proportion of times that the confidence intervals miss on the left and that on the right is similar. While, whn population comes from $\chi^2(5)$ distribution, the proportion of times that the confidence intervals miss on the left is much smaller than that on the right. This is because $\chi^2(5)$ density function leans to the right and normal density function is symmetrical.